<div class="p-6">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-white mb-2">Integrations</h2>
            <p class="text-gray-400">Connect your project to version control systems.</p>
        </div>
        <p-button label="Add Repository" icon="pi pi-plus" (onClick)="openAddDialog()"></p-button>
    </div>

    <div class="card bg-gray-800 rounded-lg border border-gray-700">
        <p-table [value]="repositories" [loading]="loading" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
                <tr>
                    <th>Type</th>
                    <th>URL</th>
                    <th>Webhook Secret</th>
                    <th>Webhook URL</th>
                    <th>Status</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-repo>
                <tr class="border-b border-gray-700">
                    <td>
                        <span class="flex items-center gap-2">
                            <i class="pi pi-github" *ngIf="repo.type === 0"></i>
                            <i class="pi pi-gitlab" *ngIf="repo.type === 1"></i>
                            {{ repo.type === 0 ? 'GitHub' : 'GitLab' }}
                        </span>
                    </td>
                    <td>
                        <a [href]="repo.url" target="_blank" class="text-blue-400 hover:underline">{{ repo.url }}</a>
                    </td>
                    <td>
                        <span class="font-mono text-sm bg-gray-900 px-2 py-1 rounded">
                            {{ repo.webhookSecret || 'None' }}
                        </span>
                    </td>
                    <td>
                        <span class="font-mono text-sm text-gray-400 select-all">
                            {{ getWebhookUrl(repo) }}
                        </span>
                    </td>
                    <td>
                        <span class="px-2 py-1 rounded text-xs bg-green-900 text-green-300">Active</span>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="5" class="text-center py-8 text-gray-400">
                        No repositories connected.
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<p-dialog [(visible)]="showAddDialog" header="Add Repository" [modal]="true" [style]="{width: '450px'}"
    styleClass="p-fluid">
    <form [formGroup]="addForm" (ngSubmit)="onSubmit()" class="flex flex-col gap-4 mt-4">
        <div class="field">
            <label class="block text-sm font-medium text-gray-300 mb-1">Type</label>
            <p-dropdown [options]="repositoryTypes" formControlName="type" optionLabel="label"
                optionValue="value"></p-dropdown>
        </div>

        <div class="field">
            <label class="block text-sm font-medium text-gray-300 mb-1">Repository URL</label>
            <input pInputText formControlName="url" placeholder="https://github.com/username/repo" />
            <small class="text-red-400" *ngIf="addForm.get('url')?.invalid && addForm.get('url')?.touched">
                Valid URL is required
            </small>
        </div>

        <div class="field">
            <label class="block text-sm font-medium text-gray-300 mb-1">Webhook Secret (Optional)</label>
            <input pInputText formControlName="webhookSecret" placeholder="Secret for webhook verification" />
        </div>

        <div class="flex justify-end gap-2 mt-4">
            <p-button label="Cancel" styleClass="p-button-text" (onClick)="showAddDialog = false"></p-button>
            <p-button label="Connect" type="submit" [disabled]="addForm.invalid"></p-button>
        </div>
    </form>
</p-dialog>

<p-toast></p-toast>